# 修复HTML引用图片的备注文本显示位置问题

## 问题分析

HTML格式的图片被包裹在 `<div style="display: flex;">` 标签内，当插入备注文本时，文本成为了flex容器的子元素，导致显示位置异常。

**当前问题**：
- flex容器内的img插入备注文本后，文本以竖向排列显示在图片右上方
- 这是因为备注文本成为了flex子元素，遵循flex布局规则

## 修复方案

### 修改processImages函数逻辑：

1. **检测父元素布局**：
   - 检查img的父元素是否是div且有flex/grid布局
   - 如果是flex容器，特殊处理

2. **处理flex容器内的图片**：
   - 不直接在flex容器内插入备注文本
   - 为每个img创建独立的包装容器
   - 在包装容器内添加图片和备注文本

3. **处理独立图片**：
   - 保持原有逻辑，直接插入备注文本

### 关键代码修改：

```javascript
processImages() {
    const flexWrappers = this.outputElement.querySelectorAll('div[style*="flex"]');
    
    flexWrappers.forEach(wrapper => {
        const flexImages = wrapper.querySelectorAll('img');
        flexImages.forEach(img => {
            const altText = img.getAttribute('alt');
            if (altText) {
                // 创建独立包装容器
                const wrapperDiv = document.createElement('div');
                wrapperDiv.style.display = 'inline-flex';
                wrapperDiv.style.flexDirection = 'column';
                wrapperDiv.style.alignItems = 'center';
                wrapperDiv.style.marginRight = '10px';
                
                // 替换原img
                img.parentNode.insertBefore(wrapperDiv, img);
                wrapperDiv.appendChild(img);
                
                // 添加备注文本
                const caption = document.createElement('div');
                caption.className = 'image-caption';
                caption.textContent = altText;
                caption.style.marginTop = '4px';
                wrapperDiv.appendChild(caption);
            }
        });
    });
    
    // 处理非flex容器内的图片
    const standaloneImages = this.outputElement.querySelectorAll('img:not(div[style*="flex"] img)');
    standaloneImages.forEach(img => {
        if (!img.closest('[style*="flex"]') && !img.closest('[style*="grid"]')) {
            const altText = img.getAttribute('alt');
            if (altText && !img.nextElementSibling?.classList.contains('image-caption')) {
                const caption = document.createElement('div');
                caption.className = 'image-caption';
                caption.textContent = altText;
                caption.style.marginTop = '4px';
                caption.style.marginBottom = '16px';
                
                if (img.parentNode) {
                    img.parentNode.insertBefore(caption, img.nextSibling);
                }
            }
        }
    });
}
```

### 效果预期：
- flex容器内的图片：备注文本显示在图片正下方，保持水平排列
- 独立图片：备注文本正常显示在图片正下方
- 不影响原有flex布局的其他内容